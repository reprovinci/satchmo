<!DOCTYPE html>  <html> <head>   <title>satchmo.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               satchmo.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <pre><code>                                           /
                                        |
                                       /|
                 _______I_I_I_________/ |
           D====/ ____________________  |  - -
                ||   __| | | |___  || \ |
                \\__[_=|_[[|_|==_]_//  \|
                 \_________________/    |  \
                        = = =
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <pre><code>Satchmo.coffee
(c) 2012 Reprovinci Internetdiensten bv
Satchmo is freely distributable under the MIT license.
Portions of Satchmo are inspired or borrowed from cmlenz's
 jQuery Ajax transport plugin.
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>The <a href="http://en.wikipedia.org/wiki/Louis_Armstrong">Satchmo</a> <a href="http://jquery.com/">jQuery</a> plugin implements two methods
for the asynchronous submission of forms. The first is used when the browser supports the XMLHttpRequest 2 API or when
the form contains no file fields. The fallback transparently submits the form using a hidden <code>&lt;iframe&gt;</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>The <a href="https://github.com/reprovinci/satchmo">source for Satchmo</a> is available on Github, and released under the MIT
license.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h2>Usage</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>To use this plugin, just submit your form using jQuery's <code>$.ajax()</code>:</p>

<pre><code>var xhr = $.ajax({ satchmo: $("#myform") });
</code></pre>

<p>You can listen for progress events by calling <code>xhr.progress(&lt;callback&gt;)</code>. Your callback will receive a
<code>XMLHttpRequestProgressEvent</code> which exposes the following properties:</p>

<pre><code>boolean lengthComputable
   long loaded  # Bytes loaded until now
   long total   # Total of bytes that will be sent
</code></pre>

<blockquote>
  <p><strong>Nota bene:</strong> <code>loaded</code> and <code>total</code> may only be used when <code>lengthComputable</code> is <code>true</code>.</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h2>Response status and data type</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>As the iframe transport layer does not have access to the HTTP headers of the server response, it is not as simple to
make use of the automatic content type detection provided by jQuery as with regular XHR. <br />
Another problem with using an iframe for file uploads is that it is impossible for the javascript code to determine the
HTTP status code of the servers response. Effectively, all of the calls you make will look like they are getting
successful responses, and thus invoke the <code>done()</code> or <code>complete()</code> callbacks.
If you can't set the expected response data type (for example because it may vary), you will need to employ a workaround
on the server side. <br />
In case the iframe transport layer kicks in, an additional <code>Satchmo__wrap</code> variable is sent along with the request to
tell the server this is an emulated AJAX request. When this variable is present, you may choose to wrap your response
in an XML document. This document should conform to the following specification:</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;response status="404"&gt;
    &lt;headers&gt;
        &lt;header name="Content-Type"&gt;application/json&lt;/header&gt;
    &lt;/headers&gt;
    &lt;content&gt;
        &lt;![CDATA[{"ok": true, "message": "Thanks so much"}]]&gt;
    &lt;/content&gt;
&lt;/response&gt;
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>The <code>status</code> attribute is optional, as is the <code>&lt;headers&gt;</code> element.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h2>Annotated source</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="s2">&quot;use strict&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>A comprehensive list of status codes for HTTP status code translation courtesy of Apache Commons.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">HTTP_STATUS_TEXT</span> <span class="o">=</span>
	<span class="mi">100</span><span class="o">:</span> <span class="s2">&quot;Continue&quot;</span>
	<span class="mi">101</span><span class="o">:</span> <span class="s2">&quot;Switching Protocols&quot;</span>
	<span class="mi">102</span><span class="o">:</span> <span class="s2">&quot;Processing&quot;</span>
	<span class="mi">200</span><span class="o">:</span> <span class="s2">&quot;OK&quot;</span>
	<span class="mi">201</span><span class="o">:</span> <span class="s2">&quot;Created&quot;</span>
	<span class="mi">202</span><span class="o">:</span> <span class="s2">&quot;Accepted&quot;</span>
	<span class="mi">203</span><span class="o">:</span> <span class="s2">&quot;Non Authoritative Information&quot;</span>
	<span class="mi">204</span><span class="o">:</span> <span class="s2">&quot;No Content&quot;</span>
	<span class="mi">205</span><span class="o">:</span> <span class="s2">&quot;Reset Content&quot;</span>
	<span class="mi">206</span><span class="o">:</span> <span class="s2">&quot;Partial Content&quot;</span>
	<span class="mi">207</span><span class="o">:</span> <span class="s2">&quot;Multi-Status&quot;</span>
	<span class="mi">300</span><span class="o">:</span> <span class="s2">&quot;Mutliple Choices&quot;</span>
	<span class="mi">301</span><span class="o">:</span> <span class="s2">&quot;Moved Permanently&quot;</span>
	<span class="mi">302</span><span class="o">:</span> <span class="s2">&quot;Moved Temporarily&quot;</span>
	<span class="mi">303</span><span class="o">:</span> <span class="s2">&quot;See Other&quot;</span>
	<span class="mi">304</span><span class="o">:</span> <span class="s2">&quot;Not Modified&quot;</span>
	<span class="mi">305</span><span class="o">:</span> <span class="s2">&quot;Use Proxy&quot;</span>
	<span class="mi">307</span><span class="o">:</span> <span class="s2">&quot;Temporary Redirect&quot;</span>
	<span class="mi">400</span><span class="o">:</span> <span class="s2">&quot;Bad Request&quot;</span>
	<span class="mi">401</span><span class="o">:</span> <span class="s2">&quot;Unauthorized&quot;</span>
	<span class="mi">402</span><span class="o">:</span> <span class="s2">&quot;Payment Required&quot;</span>
	<span class="mi">403</span><span class="o">:</span> <span class="s2">&quot;Forbidden&quot;</span>
	<span class="mi">404</span><span class="o">:</span> <span class="s2">&quot;Not Found&quot;</span>
	<span class="mi">405</span><span class="o">:</span> <span class="s2">&quot;Method Not Allowed&quot;</span>
	<span class="mi">406</span><span class="o">:</span> <span class="s2">&quot;Not Acceptable&quot;</span>
	<span class="mi">407</span><span class="o">:</span> <span class="s2">&quot;Proxy Authentication Required&quot;</span>
	<span class="mi">408</span><span class="o">:</span> <span class="s2">&quot;Request Timeout&quot;</span>
	<span class="mi">409</span><span class="o">:</span> <span class="s2">&quot;Conflict&quot;</span>
	<span class="mi">410</span><span class="o">:</span> <span class="s2">&quot;Gone&quot;</span>
	<span class="mi">411</span><span class="o">:</span> <span class="s2">&quot;Length Required&quot;</span>
	<span class="mi">412</span><span class="o">:</span> <span class="s2">&quot;Precondition Failed&quot;</span>
	<span class="mi">413</span><span class="o">:</span> <span class="s2">&quot;Request Entity Too Large&quot;</span>
	<span class="mi">414</span><span class="o">:</span> <span class="s2">&quot;Request-URI Too Long&quot;</span>
	<span class="mi">415</span><span class="o">:</span> <span class="s2">&quot;Unsupported Media Type&quot;</span>
	<span class="mi">416</span><span class="o">:</span> <span class="s2">&quot;Requested Range Not Satisfiable&quot;</span>
	<span class="mi">417</span><span class="o">:</span> <span class="s2">&quot;Expectation Failed&quot;</span>
	<span class="mi">419</span><span class="o">:</span> <span class="s2">&quot;Insufficient Space on Resource&quot;</span>
	<span class="mi">420</span><span class="o">:</span> <span class="s2">&quot;Method Failure&quot;</span>
	<span class="mi">422</span><span class="o">:</span> <span class="s2">&quot;Unprocessable Entity&quot;</span>
	<span class="mi">423</span><span class="o">:</span> <span class="s2">&quot;Locked&quot;</span>
	<span class="mi">424</span><span class="o">:</span> <span class="s2">&quot;Failed Dependency&quot;</span>
	<span class="mi">500</span><span class="o">:</span> <span class="s2">&quot;Server Error&quot;</span>
	<span class="mi">501</span><span class="o">:</span> <span class="s2">&quot;Not Implemented&quot;</span>
	<span class="mi">502</span><span class="o">:</span> <span class="s2">&quot;Bad Gateway&quot;</span>
	<span class="mi">503</span><span class="o">:</span> <span class="s2">&quot;Service Unavailable&quot;</span>
	<span class="mi">504</span><span class="o">:</span> <span class="s2">&quot;Gateway Timeout&quot;</span>
	<span class="mi">505</span><span class="o">:</span> <span class="s2">&quot;HTTP Version Not Supported&quot;</span>
	<span class="mi">507</span><span class="o">:</span> <span class="s2">&quot;Insufficient Storage&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Detect XMLHttpRequest 2 support. For <em>Satchmo</em>, this requires the presence of the FormData API.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">xml2_support</span> <span class="o">=</span> <span class="o">!!</span><span class="nb">window</span><span class="p">.</span><span class="nx">FormData</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Defers execution for <code>ms</code> milliseconds. <code>ms</code> may be omitted:</p>

<pre><code>defer     -&gt; console.log "Deferred!"
defer 100 -&gt; console.log "Deferred for 100 milliseconds!"
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">defer</span> <span class="o">=</span> <span class="p">(</span><span class="nx">ms</span><span class="p">,</span> <span class="nx">func</span><span class="p">)</span> <span class="o">-&gt;</span>
	<span class="k">if</span> <span class="k">typeof</span> <span class="nx">ms</span> <span class="o">is</span> <span class="s2">&quot;function&quot;</span>
		<span class="nx">func</span> <span class="o">=</span> <span class="nx">ms</span>
		<span class="nx">ms</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="nx">setTimeout</span> <span class="nx">func</span><span class="p">,</span> <span class="nx">ms</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Creates a version of the function that can only be called one time.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">once</span> <span class="o">=</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="o">-&gt;</span>
	<span class="nx">ran</span> <span class="o">=</span> <span class="kc">no</span>
	<span class="k">return</span> <span class="o">-&gt;</span>
		<span class="k">return</span> <span class="k">if</span> <span class="nx">ran</span>
		<span class="nx">ran</span> <span class="o">=</span> <span class="kc">yes</span>
		<span class="nx">f</span><span class="p">.</span><span class="nx">apply</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h2>The XMLHttpRequest 2 prefilter</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Register a pre-filter that checks whether the <code>satchmo</code> option is set, switching to the <code>satchmo</code> data type if the
option contains a form.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">$</span><span class="p">.</span><span class="nx">ajaxPrefilter</span> <span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">original_options</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">)</span> <span class="o">-&gt;</span>
	<span class="nx">$form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">satchmo</span><span class="p">)</span>

	<span class="k">return</span> <span class="nx">unless</span> <span class="nx">$form</span><span class="p">.</span><span class="o">is</span> <span class="s2">&quot;form&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Unless the browser supports XMLHttpRequest 2 or the forms contains no file inputs, return the <code>satchmo</code> data type,
which in turn will trigger the <code>satchmo</code> data transport.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">return</span> <span class="s2">&quot;satchmo&quot;</span> <span class="nx">unless</span> <span class="nx">xml2_support</span> <span class="o">||</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s2">&quot;input[type=file]&quot;</span><span class="p">).</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Set <code>url</code> based on the form's <code>action</code> attribute.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">options</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">prop</span> <span class="s2">&quot;action&quot;</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Get data from form, trying the XMLHttpRequest 2 API, falling back to basic serialisation.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">options</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span>
		<span class="k">if</span> <span class="nx">FormData</span>
			<span class="k">new</span> <span class="nx">FormData</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
		<span class="k">else</span>
			<span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Set request method according to form's method, falling back to <code>GET</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">options</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">prop</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">).</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">or</span> <span class="s2">&quot;GET&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Setting <code>contentType</code> to false, preventing jQuery from setting a <code>Content-Type</code> header that is missing the
boundary string.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">options</span><span class="p">.</span><span class="nx">contentType</span> <span class="o">=</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Setting <code>processData</code> to false, preventing jQuery from modifying the data before passing it to
<code>XMLHttpRequest#send()</code>. <code>FormData</code> is not convertible to string.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">options</span><span class="p">.</span><span class="nx">processData</span> <span class="o">=</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Create a new deferred for <code>progress</code> events. </p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">dfd</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">()</span>
	<span class="nx">xhr</span><span class="p">.</span><span class="nx">progress</span> <span class="o">=</span> <span class="nx">dfd</span><span class="p">.</span><span class="nx">progress</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Intercept <code>XMLHttpRequest</code> and pipe all <code>progress</code> upload events to our <code>dfd</code>.</p>

<blockquote>
  <p><strong>Nota bene:</strong> some browsers do not fire a progress event when the upload finishes (i.e. upload is at 100%).</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">old_xhr</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">xhr</span>
	<span class="nx">options</span><span class="p">.</span><span class="nx">xhr</span> <span class="o">=</span> <span class="o">-&gt;</span>
		<span class="nx">xhr</span> <span class="o">=</span> <span class="nx">old_xhr</span><span class="p">()</span>

		<span class="k">if</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">upload</span> <span class="k">instanceof</span> <span class="nx">XMLHttpRequestUpload</span>
			<span class="nx">xhr</span><span class="p">.</span><span class="nx">upload</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="s2">&quot;progress&quot;</span><span class="p">,</span> <span class="p">(</span> <span class="o">-&gt;</span> <span class="nx">dfd</span><span class="p">.</span><span class="nx">notify</span> <span class="nx">arguments</span><span class="p">...</span> <span class="p">),</span> <span class="kc">false</span>

		<span class="k">return</span> <span class="nx">xhr</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <h2>The iframe transport</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Register the iframe transport. It will only activate when the browser supports XMLHttpRequest 2 or no file
inputs are present on the form.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">$</span><span class="p">.</span><span class="nx">ajaxTransport</span> <span class="s2">&quot;satchmo&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">orig_options</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">)</span> <span class="o">-&gt;</span>
	<span class="nx">$form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">satchmo</span><span class="p">)</span>

	<span class="k">return</span> <span class="nx">unless</span> <span class="nx">$form</span><span class="p">.</span><span class="o">is</span> <span class="s2">&quot;form&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Remove <code>iframe</code> from the data types list so that further processing is based on the content type returned by the
server, without attempting an (unsupported) conversion from <code>iframe</code> to the actual type.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">options</span><span class="p">.</span><span class="nx">dataTypes</span> <span class="o">=</span> <span class="p">(</span><span class="nx">dt</span> <span class="k">for</span> <span class="nx">dt</span> <span class="k">in</span> <span class="nx">options</span><span class="p">.</span><span class="nx">dataTypes</span> <span class="k">when</span> <span class="nx">dt</span> <span class="o">isnt</span> <span class="s2">&quot;satchmo&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Create a unique request id. It will be used to name the <code>&lt;iframe&gt;</code>, which the form will target.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">request_id</span> <span class="o">=</span> <span class="s2">&quot;satchmo-#{parseInt(Math.random()*100000)}&quot;</span>

	<span class="nx">transport</span> <span class="o">=</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>The <code>send</code> function is called by jQuery when the request should be sent.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">send: </span><span class="p">(</span><span class="nx">headers</span><span class="p">,</span> <span class="nx">complete</span><span class="p">)</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Create the iframe, setting its <code>name</code> to our request id.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">$iframe</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;&lt;iframe src=\&quot;javascript:false;\&quot; name=\&quot;#{request_id}\&quot; style=\&quot;display:none\&quot;&gt;&lt;/iframe&gt;&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Create a hidden form, which does not have our original form's events and let it target our new iframe.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">$new_form</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;&lt;form enctype=\&quot;multipart/form-data\&quot;&gt;&lt;/form&gt;&quot;</span><span class="p">).</span><span class="nx">appendTo</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span>
			<span class="nx">$new_form</span><span class="p">.</span><span class="nx">prop</span>
				<span class="nv">action: </span><span class="nx">$form</span><span class="p">.</span><span class="nx">prop</span> <span class="s2">&quot;action&quot;</span>
				<span class="nv">method: </span><span class="nx">$form</span><span class="p">.</span><span class="nx">prop</span> <span class="s2">&quot;method&quot;</span>
				<span class="nv">target: </span><span class="nx">request_id</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Also send the <code>Satchmo__wrap</code> parameter, which will signal the server an XML response document may be sent.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;&lt;input type=\&quot;hidden\&quot; name=\&quot;Satchmo__wrap\&quot; value=\&quot;1\&quot;&gt;&quot;</span><span class="p">).</span><span class="nx">appendTo</span> <span class="nx">$new_form</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Temporarily move the original form elements into the new form</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">$form</span><span class="p">.</span><span class="nx">children</span><span class="p">().</span><span class="nx">appendTo</span> <span class="nx">$new_form</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>The first load event gets fired after the iframe has been injected into the DOM, and is used to prepare
the actual submission.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">$iframe</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;load.satchmo&quot;</span><span class="p">,</span> <span class="nx">once</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>The second load event gets fired when the response to the form submission is received. The
implementation detects whether the actual payload is embedded in an XML document, and prepares the
required conversions to be made in that case.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">$iframe</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;load.satchmo&quot;</span><span class="p">,</span> <span class="nx">once</span> <span class="o">-&gt;</span>
					<span class="nb">document</span>  <span class="o">=</span> <span class="err">@</span><span class="nx">contentWindow</span><span class="o">?</span><span class="p">.</span><span class="nb">document</span> <span class="o">or</span> <span class="err">@</span><span class="nx">contentDocument</span><span class="o">?</span><span class="p">.</span><span class="nb">document</span> <span class="o">or</span> <span class="err">@</span><span class="nb">document</span>
					<span class="nx">$document</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">)</span>
					<span class="nx">$root</span>     <span class="o">=</span> <span class="nx">$document</span><span class="p">.</span><span class="nx">children</span><span class="p">().</span><span class="nx">first</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>An XML document has been retrieved with information about the request status.</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="k">if</span> <span class="nx">$root</span><span class="p">.</span><span class="o">is</span> <span class="s2">&quot;response&quot;</span>
						<span class="nx">status</span> <span class="o">=</span> <span class="nx">$root</span><span class="p">.</span><span class="nx">attr</span> <span class="s2">&quot;status&quot;</span> <span class="o">||</span> <span class="mi">200</span>
						<span class="nx">statusText</span> <span class="o">=</span> <span class="nx">$root</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;status-text&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">HTTP_STATUS_TEXT</span><span class="p">[</span><span class="nx">status</span><span class="p">]</span>
						<span class="nx">content</span> <span class="o">=</span>
							<span class="nv">text: </span><span class="nx">$root</span><span class="p">.</span><span class="nx">children</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">()</span>
						<span class="nx">headers</span> <span class="o">=</span> <span class="p">[]</span>
						<span class="k">for</span> <span class="nx">header</span> <span class="k">in</span> <span class="nx">$root</span><span class="p">.</span><span class="nx">children</span><span class="p">(</span><span class="s2">&quot;headers&quot;</span><span class="p">).</span><span class="nx">children</span><span class="p">(</span><span class="s2">&quot;header&quot;</span><span class="p">)</span>
							<span class="nx">$header</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">header</span><span class="p">)</span>
							<span class="nx">headers</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;#{$header.attr &quot;</span><span class="nx">name</span><span class="s2">&quot;}: #{$header.text()}&quot;</span>
						<span class="nx">headers</span> <span class="o">=</span> <span class="nx">headers</span><span class="p">.</span><span class="nx">join</span> <span class="s2">&quot;\r\n&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Complete the AJAX request succesfully, as no information can be retrieved from the <code>&lt;iframe&gt;</code>'s
response.</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="k">else</span>
						<span class="nx">root</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span>

						<span class="nx">status</span> <span class="o">=</span> <span class="mi">200</span>
						<span class="nx">statusText</span> <span class="o">=</span> <span class="s2">&quot;OK&quot;</span>
						<span class="nx">content</span> <span class="o">=</span>
							<span class="nv">html: </span><span class="nx">root</span><span class="p">.</span><span class="nx">innerHTML</span>
							<span class="nv">text: </span><span class="nx">root</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">||</span> <span class="nx">root</span><span class="p">.</span><span class="nx">innerText</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Complete our fake AJAX request and remove the iframe and new form from the DOM.</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="nx">complete</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">statusText</span><span class="p">,</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">headers</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span>

					<span class="nx">$iframe</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
					<span class="nx">$new_form</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Submit our new form, containing all form elements, and revert the form elements' positions.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">$new_form</span><span class="p">.</span><span class="nx">submit</span><span class="p">()</span>
				<span class="nx">$new_form</span><span class="p">.</span><span class="nx">children</span><span class="p">().</span><span class="nx">appendTo</span> <span class="nx">$form</span>

			<span class="nx">$iframe</span><span class="p">.</span><span class="nx">appendTo</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Stop listening to load events, tell the iframe we no longer need our resource and clean up.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">abort: </span><span class="o">-&gt;</span>
			<span class="nx">$iframe</span><span class="p">.</span><span class="kc">off</span> <span class="s2">&quot;load.satchmo&quot;</span>
			<span class="nx">$iframe</span><span class="p">.</span><span class="nx">prop</span> <span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;javascript:false;&quot;</span>

			<span class="nx">$iframe</span><span class="p">.</span><span class="nx">remove</span><span class="p">()</span>
			<span class="nx">$new_form</span><span class="p">.</span><span class="nx">remove</span><span class="p">()</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 